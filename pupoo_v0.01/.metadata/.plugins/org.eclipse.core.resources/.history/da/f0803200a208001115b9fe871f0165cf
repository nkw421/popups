// src/main/java/com/popups/pupoo/user/application/UserService.java
package com.popups.pupoo.user.application;

import com.popups.pupoo.auth.application.TokenService;
import com.popups.pupoo.auth.domain.model.RefreshToken;
import com.popups.pupoo.auth.dto.LoginResponse;
import com.popups.pupoo.auth.persistence.RefreshTokenRepository;
import com.popups.pupoo.user.domain.enums.RoleName;     // ✅ 네가 말한 enums 패키지 통일
import com.popups.pupoo.user.domain.enums.UserStatus;  // ✅ 네가 말한 enums 패키지 통일
import com.popups.pupoo.user.domain.model.User;
import com.popups.pupoo.user.dto.UserCreateRequest;
import com.popups.pupoo.user.persistence.UserRepository;
import jakarta.servlet.http.Cookie;
import jakarta.servlet.http.HttpServletResponse;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;

import java.time.LocalDateTime;

@Service
public class UserService {

    private static final String REFRESH_COOKIE_NAME = "refresh_token";

    private final UserRepository userRepository;
    private final PasswordEncoder passwordEncoder;

    // ✅ 가입 후 자동 로그인
    private final TokenService tokenService;
    private final RefreshTokenRepository refreshTokenRepository;

    private final boolean refreshCookieSecure;
    private final int refreshCookieMaxAgeSeconds;

    public UserService(
            UserRepository userRepository,
            PasswordEncoder passwordEncoder,
            TokenService tokenService,
            RefreshTokenRepository refreshTokenRepository,
            @Value("${auth.refresh.cookie.secure:true}") boolean refreshCookieSecure,
            @Value("${auth.refresh.cookie.max-age-seconds:1209600}") int refreshCookieMaxAgeSeconds // 14 days
    ) {
        this.userRepository = userRepository;
        this.passwordEncoder = passwordEncoder;
        this.tokenService = tokenService;
        this.refreshTokenRepository = refreshTokenRepository;
        this.refreshCookieSecure = refreshCookieSecure;
        this.refreshCookieMaxAgeSeconds = refreshCookieMaxAgeSeconds;
    }

    /**
     * ✅ 회원가입 + 자동 로그인
     * - email은 로그인 키 (변경 불가 정책)
     * - 내부 식별자 user_id(AUTO_INCREMENT)로 JWT 발급
     */
    public LoginResponse create(UserCreateRequest req, HttpServletResponse response) {
        // 1) 중복 체크
        if (userRepository.existsByEmail(req.getEmail())) {
            // TODO: BusinessException/ErrorCode로 교체(프로젝트 표준에 맞춰)
            throw new IllegalArgumentException("Email already exists");
        }

        // 2) User 생성/저장
        User user = new User();
        user.setEmail(req.getEmail());
        user.setPassword(passwordEncoder.encode(req.getPassword()));
        user.setNickname(req.getNickname());
        user.setPhone(req.getPhone());
        user.setStatus(UserStatus.ACTIVE);
        user.setRoleName(RoleName.USER);

        User saved = userRepository.save(user);

        // 3) 토큰 발급 (user_id 기반)
        Long userId = saved.getUserId(); // ⚠️ 네 User.java getter가 다르면 맞춰줘
        String roleName = saved.getRoleName().name();

        String access = tokenService.createAccessToken(userId, roleName);
        String refresh = tokenService.createRefreshToken(userId);

        // 4) refresh 원문 저장(멀티 디바이스 + rotation 전제)
        RefreshToken rt = new RefreshToken();
        rt.setUserId(userId);
        rt.setToken(refresh);
        rt.setCreatedAt(LocalDateTime.now());
        // 만료는 TokenService TTL 정책과 맞추는 게 정석 (지금은 쿠키 max-age 기반으로 단순 계산)
        rt.setExpiredAt(LocalDateTime.now().plusSeconds(refreshCookieMaxAgeSeconds));
        refreshTokenRepository.save(rt);

        // 5) refresh 쿠키 세팅(HttpOnly)
        setRefreshCookie(response, refresh);

        // 6) access는 body
        return new LoginResponse(access, userId, roleName);
    }

    private void setRefreshCookie(HttpServletResponse response, String token) {
        Cookie cookie = new Cookie(REFRESH_COOKIE_NAME, token);
        cookie.setHttpOnly(true);
        cookie.setSecure(refreshCookieSecure); // 로컬 http면 false로 내려도 됨
        cookie.setPath("/");
        cookie.setMaxAge(refreshCookieMaxAgeSeconds);
        response.addCookie(cookie);
    }
}
