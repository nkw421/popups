package com.popups.pupoo.auth.application;

import com.popups.pupoo.auth.dto.LoginRequest;
import com.popups.pupoo.auth.dto.TokenResponse;
import com.popups.pupoo.auth.security.authentication.jwt.JwtProvider;
import com.popups.pupoo.auth.domain.model.RefreshToken;
import com.popups.pupoo.auth.persistence.RefreshTokenRepository;
import com.popups.pupoo.user.persistence.UserRepository;
import com.popups.pupoo.user.domain.model.User;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;

import java.time.Instant;

@Service
public class AuthService {

    private final UserRepository userRepository;
    private final PasswordEncoder passwordEncoder;
    private final JwtProvider jwtProvider;
    private final RefreshTokenRepository refreshTokenRepository;

    public AuthService(
            UserRepository userRepository,
            PasswordEncoder passwordEncoder,
            JwtProvider jwtProvider,
            RefreshTokenRepository refreshTokenRepository
    ) {
        this.userRepository = userRepository;
        this.passwordEncoder = passwordEncoder;
        this.jwtProvider = jwtProvider;
        this.refreshTokenRepository = refreshTokenRepository;
    }

    public TokenResponse login(LoginRequest request) {

        // ✅ (수정 포인트 1) 너희 UserRepository 메서드명에 맞춰 수정
        // 예: findByEmail(String email)
        User user = userRepository.findByEmail(request.getEmail())
                .orElseThrow(() -> new IllegalArgumentException("INVALID_CREDENTIALS"));

        // ✅ (수정 포인트 2) 너희 User 엔티티 비밀번호 필드 getter에 맞춰 수정
        // 예: user.getPasswordHash() / user.getPassword()
        if (!passwordEncoder.matches(request.getPassword(), user.getPassword())) {
            throw new IllegalArgumentException("INVALID_CREDENTIALS");
        }

        // subject는 보통 userId(문자열) 추천
        String subject = String.valueOf(user.getUserId()); // <-- userId getter명 맞춰 필요시 수정
        String role = "ROLE_" + user.getRoleType().name(); // <-- RoleType.USER/ADMIN 가정 (필요시 수정)

        String accessToken = jwtProvider.createAccessToken(subject, role);
        String refreshTokenValue = jwtProvider.createRefreshToken(subject, role);

        // refresh token DB 저장 (단순 예시: 유저당 1개 유지)
        RefreshToken refreshToken = RefreshToken.issue(
                user.getUserId(),
                refreshTokenValue,
                Instant.now().plusSeconds(60L * 60 * 24 * 14) // 14일 (properties와 맞추면 더 좋음)
        );
        refreshTokenRepository.save(refreshToken);

        return TokenResponse.of(accessToken, refreshTokenValue);
    }
}
