package com.popups.pupoo.auth.application;

import com.popups.pupoo.auth.dto.LoginRequest;
import com.popups.pupoo.auth.dto.LoginResponse;
import com.popups.pupoo.user.domain.model.User;
import com.popups.pupoo.user.persistence.UserRepository;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDateTime;

@Service
public class AuthService {

    private final UserRepository userRepository;
    private final PasswordEncoder passwordEncoder;
    private final TokenService tokenService;

    public AuthService(
            UserRepository userRepository,
            PasswordEncoder passwordEncoder,
            TokenService tokenService
    ) {
        this.userRepository = userRepository;
        this.passwordEncoder = passwordEncoder;
        this.tokenService = tokenService;
    }

    /**
     * ✅ 정식 로그인
     * - email로 사용자 조회
     * - status 체크 (ACTIVE만 허용)
     * - password(bcrypt) 검증
     * - last_login_at 갱신
     * - access/refresh 토큰 발급
     */
    @Transactional
    public LoginResponse login(LoginRequest request) {

        validateRequest(request);

        User user = userRepository.findByEmail(request.getEmail())
                .orElseThrow(() -> new IllegalArgumentException("INVALID_CREDENTIALS"));

        validateAccountStatus(user);

        // users.password 는 bcrypt 해시 저장 전제
        if (!passwordEncoder.matches(request.getPassword(), user.getPassword())) {
            throw new IllegalArgumentException("INVALID_CREDENTIALS");
        }

        // last_login_at 갱신 (엔티티에 맞게 구현)
        updateLastLogin(user);

        // 토큰 발급 (ROLE_USER / ROLE_ADMIN 변환은 TokenService에서 처리 권장)
        return tokenService.issueTokens(user);
    }

    private void validateRequest(LoginRequest request) {
        if (request == null) {
            throw new IllegalArgumentException("INVALID_REQUEST");
        }
        if (request.getEmail() == null || request.getEmail().isBlank()) {
            throw new IllegalArgumentException("EMAIL_REQUIRED");
        }
        if (request.getPassword() == null || request.getPassword().isBlank()) {
            throw new IllegalArgumentException("PASSWORD_REQUIRED");
        }
    }

    /**
     * users.status: ENUM('ACTIVE','SUSPENDED','DELETED')
     * - ACTIVE: 로그인 허용
     * - SUSPENDED/DELETED: 차단
     */
    private void validateAccountStatus(User user) {
        // ⚠️ User 엔티티에 status 필드가 있어야 함:
        // 예: private UserStatus status; (EnumType.STRING)
        // getStatus()가 없다면, 이 메서드 내용은 엔티티 만든 후 맞춰줘.
        String status = String.valueOf(user.getStatus()); // enum/string 어떤 타입이든 문자열로 비교

        if ("ACTIVE".equals(status)) {
            return;
        }
        if ("SUSPENDED".equals(status)) {
            throw new IllegalArgumentException("ACCOUNT_SUSPENDED");
        }
        if ("DELETED".equals(status)) {
            throw new IllegalArgumentException("ACCOUNT_DELETED");
        }

        // 혹시 모르는 값 방어
        throw new IllegalArgumentException("ACCOUNT_NOT_ALLOWED");
    }

    private void updateLastLogin(User user) {
        // ✅ 가장 깔끔한 방식: 엔티티에 updateLastLogin() 같은 메서드 만들기
        // user.updateLastLogin();

        // 엔티티에 메서드가 없다면, 아래처럼 setter로 처리해도 됨.
        user.setLastLoginAt(LocalDateTime.now());

        // last_modified_at을 엔티티에서 @PreUpdate로 자동 갱신하면 여기서 안 해도 됨.
        // 만약 직접 갱신하려면:
        // user.setLastModifiedAt(LocalDateTime.now());
    }
}
