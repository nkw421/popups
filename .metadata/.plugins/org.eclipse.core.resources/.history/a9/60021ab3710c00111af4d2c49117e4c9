// src/main/java/com/popups/pupoo/pet/application/PetServiceImpl.java
package com.popups.pupoo.pet.application;

import com.popups.pupoo.common.exception.BusinessException;
import com.popups.pupoo.common.exception.ErrorCode;
import com.popups.pupoo.pet.domain.model.Pet;
import com.popups.pupoo.pet.dto.PetCreateRequest;
import com.popups.pupoo.pet.dto.PetMeResponse;
import com.popups.pupoo.pet.dto.PetResponse;
import com.popups.pupoo.pet.dto.PetUpdateRequest;
import com.popups.pupoo.pet.persistence.PetRepository;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;

/**
 * Pet 도메인 비즈니스 로직 구현
 * - 수정/삭제는 소유권 검증 포함
 * - 내 펫 조회는 없으면 빈 리스트 반환
 */
@Service
@Transactional
public class PetServiceImpl implements PetService {

    private final PetRepository petRepository;

    public PetServiceImpl(PetRepository petRepository) {
        this.petRepository = petRepository;
    }

    /**
     * 반려동물 등록
     */
    @Override
    public Long create(Long userId, PetCreateRequest request) {
        Pet pet = new Pet(
                userId,
                request.petName(),
                request.petBreed(),
                request.petAge()
        );
        return petRepository.save(pet).getPetId();
    }

    /**
     * 반려동물 수정
     * - 없거나 내 소유가 아니면 PET_NOT_FOUND (보안상 404)
     */
    @Override
    public void update(Long userId, Long petId, PetUpdateRequest request) {
        Pet pet = petRepository.findByPetIdAndUserId(petId, userId)
                .orElseThrow(() -> new BusinessException(ErrorCode.PET_NOT_FOUND));

        pet.update(
                request.petName(),
                request.petBreed(),
                request.petAge()
        );
    }

    /**
     * 반려동물 삭제
     * - 없거나 내 소유가 아니면 PET_NOT_FOUND (보안상 404)
     */
    @Override
    public void delete(Long userId, Long petId) {
        Pet pet = petRepository.findByPetIdAndUserId(petId, userId)
                .orElseThrow(() -> new BusinessException(ErrorCode.PET_NOT_FOUND));

        petRepository.delete(pet);
    }

    /**
     * 내 반려동물 목록 조회
     * - 펫이 없을 수 있으므로 빈 리스트도 정상 반환
     */
    @Override
    @Transactional(readOnly = true)
    public PetMeResponse getMe(Long userId) {
        List<PetResponse> pets = petRepository.findAllByUserIdOrderByPetIdDesc(userId).stream()
                .map(PetResponse::from)
                .toList();

        return new PetMeResponse(pets);
    }
}
